---
alwaysApply: true
---

# 🏭 Ceramic Workshop Backend - 开发规范

> **磨料车间后端 API** - FastAPI + InfluxDB + S7-1200 PLC

---

## 📋 1. 项目概览

```yaml
项目名称: ceramic-workshop-backend
应用类型: 工业物联网后端 API
技术栈: Python 3.12 / FastAPI 0.109 / python-snap7 1.3
数据库: InfluxDB 2.x (时序数据) + SQLite (本地缓存) + YAML (配置)
通信协议: Siemens S7-1200 PLC (S7 Protocol)
部署方式: Docker Compose (工控机本地部署)
前端: Flutter Desktop (Windows)
```

### 核心特性
- ✅ **实时数据采集**: 每 6 秒从 PLC 读取数据
- ✅ **批量写入优化**: 10 次轮询后批量写入 InfluxDB（减少 90% 写入次数）
- ✅ **本地缓存**: SQLite 缓存最新数据，提升 API 响应速度
- ✅ **自动投料分析**: 每 6 小时自动分析投料事件
- ✅ **健康检查**: PLC 连接状态监控
- ✅ **动态配置**: 支持运行时修改 PLC 配置

---

## 🗂️ 2. 设备清单

| DB块 | 设备 | 数量 | 模块 | 关键数据 |
|------|------|------|------|---------|
| **DB8** | 料仓 | 9个 | 电表+温度+称重 | `weight`, `feed_rate`, `temperature`, `Pt`, `ImpEp` |
| **DB9** | 辊道窑 | 1个(6温区) | 电表+温度 | `temperature`, `Pt`, `ImpEp`, `I_0~I_2` |
| **DB10** | SCR+风机 | 4个(2+2) | 电表+燃气 | `Pt`, `ImpEp`, `flow_rate`, `total_flow` |
| **DB3** | 料仓状态位 | 9个 | 数字量 | `error`, `status_code` |
| **DB7** | 辊道窑状态位 | 6个 | 数字量 | `error`, `status_code` |
| **DB11** | SCR/风机状态位 | 4个 | 数字量 | `error`, `status_code` |

### 设备详细映射

#### 料仓 (9个)
```yaml
short_hopper_1~4: 短料仓 (对应窑 7,6,5,4)
no_hopper_1~2:    无料仓 (对应窑 2,1)
long_hopper_1~3:  长料仓 (对应窑 8,3,9)
```

#### 辊道窑 (6温区)
```yaml
zone1~zone6: 1-6号温区
```

#### SCR + 风机 (4个)
```yaml
scr_1~2:  SCR氨水泵 (表63, 表64)
fan_1~2:  风机 (表65, 表66)
```

---

## 🏗️ 3. 架构设计

### 目录结构
```
ceramic-workshop-backend/
├── main.py                    # 🚀 FastAPI 应用入口
├── config.py                  # ⚙️ 配置管理 (pydantic-settings)
├── requirements.txt           # 📦 Python 依赖
├── docker-compose.yml         # 🐳 Docker 编排
├── Dockerfile                 # 🐳 Docker 镜像
├── README.md                  # 📖 项目文档
│
├── configs/                   # 📁 YAML 配置文件
│   ├── plc_modules.yaml       # PLC 模块定义
│   ├── db_mappings.yaml       # DB 块映射
│   ├── config_hoppers_8.yaml # DB8 料仓配置
│   ├── config_roller_kiln_9.yaml  # DB9 辊道窑配置
│   ├── config_scr_fans_10.yaml    # DB10 SCR/风机配置
│   ├── status_hopper_3.yaml       # DB3 料仓状态位
│   ├── status_roller_kiln_7.yaml  # DB7 辊道窑状态位
│   └── status_scr_fan_11.yaml     # DB11 SCR/风机状态位
│
├── app/
│   ├── models/                # 📊 Pydantic 数据模型
│   │   ├── response.py        # 统一响应格式
│   │   ├── kiln.py            # 料仓/辊道窑模型
│   │   └── scr.py             # SCR/风机模型
│   │
│   ├── services/              # 🔧 业务逻辑层
│   │   ├── polling_service.py         # PLC 轮询服务
│   │   ├── plc_service.py             # PLC 通信服务
│   │   ├── history_query_service.py   # 历史数据查询
│   │   ├── feeding_analysis_service.py # 投料分析
│   │   └── data_seeder.py             # 模拟数据生成
│   │
│   ├── routers/               # 🌐 API 路由 (Controllers)
│   │   ├── health.py          # 健康检查
│   │   ├── hopper.py          # 料仓 API
│   │   ├── roller.py          # 辊道窑 API
│   │   ├── scr_fan.py         # SCR/风机 API
│   │   ├── status.py          # 状态位 API
│   │   ├── devices.py         # 设备列表 API
│   │   └── config.py          # 配置管理 API
│   │
│   ├── core/                  # 🛠️ 核心工具
│   │   ├── influxdb.py        # InfluxDB 客户端
│   │   ├── influx_schema.py   # InfluxDB Schema 定义
│   │   ├── influx_migration.py # Schema 自动迁移
│   │   ├── local_cache.py     # SQLite 本地缓存
│   │   └── timezone_utils.py  # 时区工具
│   │
│   ├── plc/                   # 🔌 PLC 通信模块
│   │   ├── s7_client.py       # S7 协议客户端
│   │   ├── plc_manager.py     # PLC 连接管理
│   │   ├── config_manager.py  # 配置管理器
│   │   ├── config_storage.py  # 配置存储
│   │   ├── module_parser.py   # 模块解析器
│   │   ├── parser_hopper.py   # 料仓数据解析
│   │   ├── parser_roller_kiln.py # 辊道窑数据解析
│   │   ├── parser_scr_fan.py     # SCR/风机数据解析
│   │   └── parser_device_status.py # 状态位数据解析
│   │
│   └── tools/                 # 🔨 数据转换器
│       ├── converter_base.py  # 转换器基类
│       ├── converter_elec.py  # 电表数据转换
│       ├── converter_temp.py  # 温度数据转换
│       ├── converter_weight.py # 称重数据转换
│       └── converter_flow.py  # 流量数据转换
│
├── data/                      # 💾 本地数据
│   └── cache.db               # SQLite 缓存数据库
│
├── scripts/                   # 🧪 测试脚本
│   ├── start.sh               # Linux 启动脚本
│   ├── start.ps1              # Windows 启动脚本
│   ├── test_all_apis.py       # API 测试
│   └── populate_feeding_data.py # 投料数据填充
│
└── tests/                     # 🧪 单元测试
    ├── integration/           # 集成测试
    ├── mock/                  # Mock 数据
    └── data_table/            # 数据表测试
```

### 数据流架构
```
┌─────────────┐
│ PLC S7-1200 │ (DB8/9/10/3/7/11)
└──────┬──────┘
       │ S7 Protocol (每 6 秒)
       ↓
┌──────────────────┐
│ polling_service  │ 轮询服务
└──────┬───────────┘
       │
       ↓
┌──────────────────┐
│ parser_*.py      │ 数据解析
└──────┬───────────┘
       │
       ↓
┌──────────────────┐
│ converter_*.py   │ 数据转换 (电流变比、单位转换)
└──────┬───────────┘
       │
       ├─────────────────────┐
       ↓                     ↓
┌──────────────┐      ┌──────────────┐
│ local_cache  │      │  InfluxDB    │ (批量写入，10次/批)
│  (SQLite)    │      │  (时序数据)   │
└──────┬───────┘      └──────┬───────┘
       │                     │
       └──────────┬──────────┘
                  ↓
           ┌──────────────┐
           │  routers/    │ REST API
           └──────┬───────┘
                  │ HTTP/JSON
                  ↓
           ┌──────────────┐
           │ Flutter App  │ 前端应用
           └──────────────┘
```

### 核心依赖
```python
# 框架
fastapi==0.109.0          # Web 框架
uvicorn==0.27.0           # ASGI 服务器
pydantic==2.5.3           # 数据验证
pydantic-settings==2.1.0  # 配置管理

# 数据库
influxdb-client==1.40.0   # InfluxDB 客户端

# PLC 通信
python-snap7==1.3         # S7 协议

# 工具
python-dotenv==1.0.0      # 环境变量
pyyaml==6.0.1             # YAML 解析

# 安全
python-jose==3.3.0        # JWT
passlib==1.7.4            # 密码加密

# 测试
pytest==7.4.4             # 单元测试
httpx==0.26.0             # HTTP 客户端
```

---

## 📝 4. 代码规范

### 文件头注释 (必须)
```python
# ============================================================
# 文件说明: xxx_service.py - XXX业务服务层
# ============================================================
# 方法列表:
# 1. get_realtime_data()    - 获取实时数据
# 2. get_history_data()     - 获取历史数据
# ============================================================
```

### 方法注释 (必须)
```python
# ------------------------------------------------------------
# 1. get_realtime_data() - 获取实时数据
# ------------------------------------------------------------
def get_realtime_data(self, device_id: str) -> Dict[str, Any]:
    """
    获取指定设备的实时数据
    
    Args:
        device_id: 设备ID (如 'short_hopper_1', 'zone1')
        
    Returns:
        Dict[str, Any]: 设备实时数据
        
    Raises:
        ValueError: 设备ID不存在
    """
    pass
```

### 编码原则

#### ✅ 要做
- **代码自文档化**: 使用清晰的变量名和函数名
- **单一职责**: 每个函数只做一件事
- **类型注解**: 所有函数参数和返回值都要有类型注解
- **错误处理**: 使用 try-except 捕获异常，记录日志
- **日志记录**: 关键操作都要记录日志

#### ❌ 不要
- **过度封装**: 不要为了封装而封装
- **提前优化**: 先实现功能，再优化性能
- **未使用的代码**: 及时删除注释掉的代码
- **魔法数字**: 使用常量替代硬编码的数字

### 代码风格
```python
# ✅ 好的例子
def get_hopper_realtime(device_id: str) -> Dict[str, Any]:
    """获取料仓实时数据"""
    cache = get_local_cache()
    data = cache.get(f"hopper:{device_id}")
    
    if data is None:
        raise ValueError(f"设备 {device_id} 不存在")
    
    return data

# ❌ 不好的例子
def get_data(id):  # 缺少类型注解
    c = get_cache()  # 变量名不清晰
    d = c.get(id)  # 缺少错误处理
    return d
```

### 函数长度
- **推荐**: ≤ 30 行
- **最大**: ≤ 50 行
- **超过 50 行**: 考虑拆分成多个函数

### 类的使用
- **有状态**: 使用类 (如 `PLCManager`, `PollingService`)
- **无状态**: 使用函数 (如数据转换器)
- **单例**: 使用 `@lru_cache` 装饰器

---

## 🌐 5. API 设计规范

### 核心批量接口 (大屏实时监控用)

这些接口是前端最常用的，每 5 秒调用一次：

```http
GET /api/hopper/realtime/batch          # 9个料仓实时数据
GET /api/roller/realtime/formatted      # 辊道窑6温区实时数据
GET /api/scr-fan/realtime/batch         # 4个SCR+风机实时数据
GET /api/status/all                     # 所有设备状态位
```

### 单设备接口

```http
# 料仓
GET /api/hopper/{device_id}                    # 单个料仓实时数据
GET /api/hopper/{device_id}/history            # 料仓历史数据
GET /api/hopper/{device_id}/temperature        # 料仓温度历史
GET /api/hopper/{device_id}/weight             # 料仓称重历史
GET /api/hopper/{device_id}/energy             # 料仓能耗历史
GET /api/hopper/{device_id}/feeding            # 料仓投料记录

# 辊道窑
GET /api/roller/realtime                       # 辊道窑实时数据
GET /api/roller/zone/{zone_id}                 # 单个温区实时数据
GET /api/roller/history                        # 辊道窑历史数据
GET /api/roller/zone/{zone_id}/temperature     # 温区温度历史
GET /api/roller/zone/{zone_id}/power           # 温区功率历史

# SCR/风机
GET /api/scr/{device_id}                       # SCR实时数据
GET /api/fan/{device_id}                       # 风机实时数据
GET /api/scr/{device_id}/history               # SCR历史数据
GET /api/fan/{device_id}/history               # 风机历史数据
GET /api/scr/{device_id}/power                 # SCR功率历史
GET /api/scr/{device_id}/gas                   # SCR燃气历史
```

### 系统接口

```http
# 健康检查
GET  /api/health                               # 系统健康状态
GET  /api/health/plc                           # PLC 连接状态
GET  /api/health/influxdb                      # InfluxDB 连接状态

# 配置管理
GET  /api/config/plc                           # 获取 PLC 配置
PUT  /api/config/plc                           # 更新 PLC 配置
POST /api/config/plc/test                      # 测试 PLC 连接

# 设备列表
GET  /api/devices/hoppers                      # 料仓列表
GET  /api/devices/zones                        # 温区列表
GET  /api/devices/scr                          # SCR列表
GET  /api/devices/fans                         # 风机列表
```

### 响应格式

#### 成功响应
```json
{
  "success": true,
  "data": {
    "device_id": "short_hopper_1",
    "temperature": 850.5,
    "weight": 450.2,
    "power": 12.5
  }
}
```

#### 失败响应
```json
{
  "success": false,
  "error": "设备 short_hopper_999 不存在"
}
```

#### 批量响应
```json
{
  "success": true,
  "data": {
    "devices": [
      {"device_id": "short_hopper_1", ...},
      {"device_id": "short_hopper_2", ...}
    ],
    "timestamp": "2026-01-26T12:00:00Z"
  }
}
```

#### 历史数据响应
```json
{
  "success": true,
  "data": [
    {
      "time": "2026-01-26T12:00:00Z",
      "temperature": 850.5,
      "weight": 450.2
    }
  ],
  "count": 100
}
```

### 查询参数

#### 时间范围
```http
?start=2026-01-26T00:00:00Z    # 开始时间 (ISO 8601)
?end=2026-01-26T23:59:59Z      # 结束时间 (ISO 8601)
```

#### 聚合
```http
?interval=1h                    # 聚合间隔 (1m, 5m, 1h, 1d)
?aggregate=mean                 # 聚合函数 (mean, max, min, sum)
```

#### 分页
```http
?limit=100                      # 返回数量限制
?offset=0                       # 偏移量
```

---

## 🔌 6. PLC 通信规范

### S7-1200 连接配置
```yaml
IP: 192.168.50.223
Rack: 0              # S7-1200 固定值
Slot: 1              # S7-1200 固定值
Timeout: 5000ms      # 连接超时
Poll_Interval: 6s    # 轮询间隔
```

### 数据类型 (Big Endian 字节序)

```python
import snap7.util as s7util

# REAL (32-bit float, 4 bytes)
temperature = s7util.get_real(data, offset=0)

# INT (16-bit signed, 2 bytes)
status_code = s7util.get_int(data, offset=4)

# DINT (32-bit signed, 4 bytes)
total_count = s7util.get_dint(data, offset=6)

# BOOL (1 bit)
error_flag = s7util.get_bool(data, byte_offset=10, bit_offset=0)

# WORD (16-bit unsigned, 2 bytes)
status_word = s7util.get_word(data, offset=12)
```

### 批量读取 (推荐)

```python
# ✅ 推荐：一次读取整个 DB 块
data = client.db_read(db_number=8, start=0, size=200)

# ❌ 不推荐：多次读取单个字段
temp1 = client.db_read(8, 0, 4)
temp2 = client.db_read(8, 4, 4)
temp3 = client.db_read(8, 8, 4)
```

### DB 块映射

| DB块 | 大小 | 用途 | 读取频率 |
|------|------|------|---------|
| DB8 | 200 bytes | 9个料仓数据 | 每 6 秒 |
| DB9 | 150 bytes | 辊道窑6温区数据 | 每 6 秒 |
| DB10 | 100 bytes | SCR+风机数据 | 每 6 秒 |
| DB3 | 50 bytes | 料仓状态位 | 每 5 秒 |
| DB7 | 30 bytes | 辊道窑状态位 | 每 5 秒 |
| DB11 | 20 bytes | SCR/风机状态位 | 每 5 秒 |

### 错误处理

```python
from snap7.exceptions import Snap7Exception

try:
    data = client.db_read(db_number, start, size)
except Snap7Exception as e:
    if "Address out of range" in str(e):
        logger.error(f"DB{db_number} 地址越界，检查 size 参数")
    elif "Connection" in str(e):
        logger.error(f"PLC 连接失败，检查 IP: {plc_ip}")
    else:
        logger.error(f"PLC 读取失败: {e}")
    raise
```

### 电流变比说明

**重要**: 电表读取的是电流互感器二次侧数据，需要乘以变比得到一次侧实际电流。

| 设备类型 | 电流变比 | 计算公式 | 示例 |
|---------|---------|---------|------|
| **辊道窑** (DB9) | 60 | `实际电流 = PLC值 × 0.1 × 60` | PLC=50 → 300A |
| **料仓** (DB8) | 20 | `实际电流 = PLC值 × 0.1 × 20` | PLC=50 → 100A |
| **SCR/风机** (DB10) | 20 | `实际电流 = PLC值 × 0.1 × 20` | PLC=50 → 100A |

**代码实现**:
```python
# converter_elec.py
def convert_current(plc_value: float, device_type: str) -> float:
    """转换电流值（应用变比）"""
    ratio = 60 if device_type == "roller_kiln" else 20
    return plc_value * 0.1 * ratio
```

---

## 💾 7. InfluxDB 规范

### Measurement 设计

```python
# 料仓数据
measurement: "hopper_data"
tags: {
    "device_id": "short_hopper_1",
    "device_type": "short_hopper"
}
fields: {
    "temperature": 850.5,      # 温度 (°C)
    "weight": 450.2,           # 重量 (kg)
    "feed_rate": 12.5,         # 投料速率 (kg/h)
    "Pt": 15.8,                # 有功功率 (kW)
    "ImpEp": 1250.3            # 累计电量 (kWh)
}

# 辊道窑数据
measurement: "roller_kiln_data"
tags: {
    "zone_id": "zone1",
    "device_type": "roller_kiln"
}
fields: {
    "temperature": 1200.5,     # 温度 (°C)
    "Pt": 85.6,                # 有功功率 (kW)
    "ImpEp": 5420.8,           # 累计电量 (kWh)
    "Ua_0": 380.5,             # A相电压 (V)
    "I_0": 120.3,              # A相电流 (A)
    "I_1": 118.7,              # B相电流 (A)
    "I_2": 122.1               # C相电流 (A)
}

# SCR/风机数据
measurement: "scr_fan_data"
tags: {
    "device_id": "scr_1",
    "device_type": "scr"
}
fields: {
    "Pt": 25.3,                # 有功功率 (kW)
    "ImpEp": 850.6,            # 累计电量 (kWh)
    "flow_rate": 15.8,         # 流量 (m³/h)
    "total_flow": 12500.3      # 累计流量 (m³)
}

# 状态位数据
measurement: "device_status"
tags: {
    "device_id": "short_hopper_1",
    "device_type": "hopper"
}
fields: {
    "error": false,            # 故障标志
    "status_code": 0           # 状态码
}
```

### 数据保留策略

```python
# InfluxDB Retention Policies
realtime: 7天      # 原始数据 (6秒间隔)
hourly: 90天       # 小时聚合
daily: 2年         # 日聚合
```

### 批量写入优化

```python
# config.py
batch_write_size: 10  # 每 10 次轮询批量写入一次

# 计算：
# - 轮询间隔: 6秒
# - 批量间隔: 6秒 × 10 = 60秒 (1分钟)
# - 每次轮询: ~46个数据点
# - 每次批量: 46 × 10 = 460个数据点
# - 写入频率: 1次/分钟 (减少 90% 写入次数)
```

### 查询示例

```python
# 查询料仓最近1小时的温度数据
query = f'''
from(bucket: "sensor_data")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "hopper_data")
  |> filter(fn: (r) => r["device_id"] == "short_hopper_1")
  |> filter(fn: (r) => r["_field"] == "temperature")
'''

# 查询辊道窑所有温区的平均温度
query = f'''
from(bucket: "sensor_data")
  |> range(start: -1h)
  |> filter(fn: (r) => r["_measurement"] == "roller_kiln_data")
  |> filter(fn: (r) => r["_field"] == "temperature")
  |> aggregateWindow(every: 5m, fn: mean)
'''

# 查询料仓投料事件 (重量变化 > 10kg)
query = f'''
from(bucket: "sensor_data")
  |> range(start: -24h)
  |> filter(fn: (r) => r["_measurement"] == "hopper_data")
  |> filter(fn: (r) => r["_field"] == "weight")
  |> derivative(unit: 1m, nonNegative: false)
  |> filter(fn: (r) => r["_value"] < -10.0)
'''
```

### Schema 自动迁移

```python
# app/core/influx_migration.py
def auto_migrate_on_startup():
    """应用启动时自动检查并创建 Schema"""
    # 1. 检查 Bucket 是否存在
    # 2. 创建 Retention Policies
    # 3. 创建必要的 Continuous Queries
    pass
```

---

## 🚀 8. 开发命令

### 启动服务

```bash
# 1. 启动 InfluxDB (Docker)
docker-compose up -d

# 2. 安装依赖
pip install -r requirements.txt

# 3. 启动后端 (开发模式)
python main.py

# 或使用 uvicorn
uvicorn main:app --reload --host 0.0.0.0 --port 8080

# 4. 访问 API 文档
# http://localhost:8080/docs
```

### Windows 快速启动

```powershell
# scripts/start.ps1
.\scripts\start.ps1
```

### Linux 快速启动

```bash
# scripts/start.sh
./scripts/start.sh
```

### 测试

```bash
# 运行所有测试
pytest tests/ -v

# 运行集成测试
pytest tests/integration/ -v

# 运行单个测试文件
pytest tests/integration/test_db8_full_flow.py -v

# 测试 API
python scripts/test_all_apis.py

# 测试完整数据流
python scripts/test_complete_flow.py
```

### 代码检查

```bash
# 使用 ruff (推荐)
ruff check .
ruff format .

# 或使用 black + flake8
black .
flake8 .
```

### 数据库操作

```bash
# 查询测试数据
python scripts/query_test_data.py

# 插入测试数据
python scripts/insert_test_data.py

# 填充投料数据
python scripts/populate_feeding_data.py

# 迁移 InfluxDB
python scripts/migrate_influxdb.py
```

### Docker 部署

```bash
# 构建镜像
docker build -t ceramic-workshop-backend:1.0.0 .

# 运行容器
docker run -d \
  --name ceramic-backend \
  -p 8080:8080 \
  -e PLC_IP=192.168.50.223 \
  -e INFLUX_URL=http://influxdb:8086 \
  ceramic-workshop-backend:1.0.0

# 查看日志
docker logs -f ceramic-backend

# 停止容器
docker stop ceramic-backend
```

---

## ⚙️ 9. 环境变量

### .env 文件配置

```bash
# ============================================================
# 服务器配置
# ============================================================
SERVER_HOST=0.0.0.0
SERVER_PORT=8080
DEBUG=true

# ============================================================
# 功能开关
# ============================================================
# 是否启用 PLC 轮询服务 (Docker 部署时可设为 false，使用 mock 服务)
ENABLE_POLLING=true

# 是否使用模拟数据 (开发环境可设为 true)
MOCK_MODE=false

# 是否显示详细轮询日志 (生产环境建议设为 false)
VERBOSE_POLLING_LOG=false

# ============================================================
# PLC 配置
# ============================================================
PLC_IP=192.168.50.223
PLC_RACK=0
PLC_SLOT=1
PLC_TIMEOUT=5000              # 连接超时 (ms)
PLC_POLL_INTERVAL=6           # 轮询间隔 (秒)

# ============================================================
# 批量写入配置
# ============================================================
BATCH_WRITE_SIZE=10           # 多少次轮询后批量写入 InfluxDB

# ============================================================
# InfluxDB 配置
# ============================================================
INFLUX_URL=http://localhost:8086
INFLUX_TOKEN=ceramic-workshop-token
INFLUX_ORG=ceramic-workshop
INFLUX_BUCKET=sensor_data

# ============================================================
# 本地缓存配置
# ============================================================
LOCAL_CACHE_PATH=data/cache.db

# ============================================================
# 配置文件路径
# ============================================================
CONFIG_DIR=configs
SENSORS_CONFIG_FILE=configs/sensors.yaml
DEVICES_CONFIG_FILE=configs/devices.yaml

# ============================================================
# JWT 配置 (可选)
# ============================================================
SECRET_KEY=ceramic-workshop-dev-only-change-in-production
ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440  # 24小时
```

### Docker Compose 环境变量

```yaml
# docker-compose.yml
services:
  backend:
    environment:
      - ENABLE_POLLING=false      # Docker 环境禁用轮询
      - MOCK_MODE=true            # 使用模拟数据
      - INFLUX_URL=http://influxdb:8086
      - PLC_IP=192.168.50.223
```

### 生产环境配置

```bash
# 生产环境建议配置
DEBUG=false
VERBOSE_POLLING_LOG=false
ENABLE_POLLING=true
MOCK_MODE=false
BATCH_WRITE_SIZE=10
```

---

## ❓ 10. 常见问题与解决方案

### PLC 连接问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| `Connection failed` | 网络不通 | 1. `ping 192.168.50.223` 检查网络<br>2. 检查防火墙设置<br>3. 确认 PLC 在线 |
| `Address out of range` | DB块大小不足 | 1. 检查 YAML 配置中的 `size` 参数<br>2. 在 TIA Portal 中确认 DB 块实际大小 |
| `Invalid Rack/Slot` | 参数错误 | S7-1200 固定使用 `Rack=0, Slot=1` |
| `Timeout` | 响应超时 | 1. 增加 `PLC_TIMEOUT` 值<br>2. 检查 PLC 负载 |

### InfluxDB 问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| `Bucket not found` | Bucket 未创建 | 1. 访问 http://localhost:8086<br>2. 手动创建 `sensor_data` Bucket |
| `Unauthorized` | Token 错误 | 1. 检查 `.env` 中的 `INFLUX_TOKEN`<br>2. 在 InfluxDB UI 中重新生成 Token |
| `Write timeout` | 批量写入过大 | 减小 `BATCH_WRITE_SIZE` 值 |
| `Connection refused` | InfluxDB 未启动 | `docker-compose up -d` 启动 InfluxDB |

### 数据解析问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| 温度值异常 (如 -999) | 字节序错误 | 确保使用 Big Endian (`s7util.get_real`) |
| 电流值偏小 | 未应用变比 | 检查 `converter_elec.py` 中的变比计算 |
| 数据全为 0 | PLC 未写入数据 | 1. 检查 PLC 程序是否运行<br>2. 确认 DB 块地址映射 |

### 性能问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| API 响应慢 | 未使用缓存 | 1. 检查 `local_cache.py` 是否正常<br>2. 使用批量接口而非单设备接口 |
| CPU 占用高 | 轮询间隔过短 | 增加 `PLC_POLL_INTERVAL` 值 (建议 ≥6秒) |
| 内存占用高 | 批量写入积压 | 减小 `BATCH_WRITE_SIZE` 值 |

### 部署问题

| 问题 | 原因 | 解决方案 |
|-----|------|---------|
| Docker 容器启动失败 | 端口占用 | `netstat -ano | findstr 8080` 检查端口 |
| 前端无法访问 | CORS 配置 | 检查 `main.py` 中的 CORS 设置 |
| 日志过多 | 详细日志开启 | 设置 `VERBOSE_POLLING_LOG=false` |

---

## 📚 11. 最佳实践

### 开发流程

1. **本地开发**
   ```bash
   # 1. 启动 InfluxDB
   docker-compose up -d
   
   # 2. 使用 Mock 模式开发
   export MOCK_MODE=true
   python main.py
   
   # 3. 测试 API
   curl http://localhost:8080/api/health
   ```

2. **集成测试**
   ```bash
   # 1. 连接真实 PLC
   export MOCK_MODE=false
   export PLC_IP=192.168.50.223
   
   # 2. 运行集成测试
   pytest tests/integration/ -v
   ```

3. **生产部署**
   ```bash
   # 1. 构建 Docker 镜像
   docker build -t ceramic-backend:1.0.0 .
   
   # 2. 部署到工控机
   docker run -d --name ceramic-backend \
     -p 8080:8080 \
     -e ENABLE_POLLING=true \
     -e MOCK_MODE=false \
     ceramic-backend:1.0.0
   ```

### 性能优化建议

1. **批量接口优先**: 前端使用 `/realtime/batch` 而非单设备接口
2. **合理轮询间隔**: 6 秒是平衡实时性和性能的最佳值
3. **批量写入**: 保持 `BATCH_WRITE_SIZE=10` (1分钟写入一次)
4. **本地缓存**: 所有实时数据都应缓存到 SQLite
5. **日志控制**: 生产环境关闭详细日志

### 安全建议

1. **修改默认 Token**: 生产环境必须修改 `SECRET_KEY` 和 `INFLUX_TOKEN`
2. **网络隔离**: PLC 和后端应在独立的内网
3. **HTTPS**: 如果需要外网访问，使用 Nginx + SSL
4. **访问控制**: 考虑添加 JWT 认证

---



### 常用 API 速查

```bash
# 健康检查
curl http://localhost:8080/api/health

# 料仓批量数据
curl http://localhost:8080/api/hopper/realtime/batch

# 辊道窑数据
curl http://localhost:8080/api/roller/realtime/formatted

# SCR/风机批量数据
curl http://localhost:8080/api/scr-fan/realtime/batch

# 所有设备状态
curl http://localhost:8080/api/status/all

# PLC 连接状态
curl http://localhost:8080/api/health/plc
```

### 日志位置

```bash
# 应用日志 (stdout)
docker logs -f ceramic-backend

# InfluxDB 日志
docker logs -f influxdb

# 本地缓存数据库
data/cache.db
```

---

## 📞 13. 技术支持

### 文档链接

- **FastAPI**: https://fastapi.tiangolo.com/
- **InfluxDB**: https://docs.influxdata.com/
- **python-snap7**: https://python-snap7.readthedocs.io/
- **Pydantic**: https://docs.pydantic.dev/

### 项目信息

```yaml
版本: 1.0.0
维护者: Ceramic Workshop Team
最后更新: 2026-01-26
Python 版本: 3.12+
```

---

**🎉 规范文档整理完成！现在可以开始启动后端进行测试了。**
