---
alwaysApply: true
---

# Python 工业后端 API 模板

> **使用说明**: 复制此模板，修改 `[占位符]` 内容即可快速生成新项目的 AI 提示词。

---

## 1. 项目定义 (必填)

```yaml
项目名称: [ceramic-workshop-backend]
应用类型: 工业物联网后端 API
技术栈: Python 3.11+ / FastAPI / python-snap7
数据库: InfluxDB (时序) + YAML (配置)
通信协议: [Siemens S7-1200 PLC]
部署方式: Docker Compose (工控机本地)
```

---

## 2. 设备清单 (按需修改)

| DB块 | 设备 | 模块 | 数据 |
|------|------|------|------|
| [DB8] | [9料仓] | 电表+温度+称重 | weight, feed_rate, temperature |
| [DB9] | [1辊道窑 6温区] | 电表+温度 | Pt, ImpEp, Ua_0, I_0~I_2 |
| [DB10] | [2SCR + 2风机] | 电表+燃气 | flow_rate, total_flow |

---

## 3. 架构规范

### 目录结构
```
project/
├── main.py              # 入口, uvicorn 启动
├── config.py            # 配置管理 (pydantic-settings)
├── requirements.txt
├── configs/             # YAML 配置文件
│   ├── plc_modules.yaml
│   └── db_mappings.yaml
├── app/
│   ├── models/          # Pydantic 数据模型
│   ├── services/        # 业务逻辑层
│   ├── routers/         # API 路由 (Controllers)
│   ├── core/            # 核心工具 (InfluxDB, 缓存)
│   ├── plc/             # PLC 通信模块
│   └── tools/           # 数据转换器
├── tests/
├── docker-compose.yml
└── Dockerfile
```

### 数据流
```
PLC (S7协议) → plc/ → services/ → InfluxDB
                ↓
           routers/ → Flutter App
```

### 核心依赖
```
fastapi, uvicorn, python-snap7, influxdb-client, pydantic-settings, pyyaml
```

---

## 4. 代码规范

### 文件头注释 (必须)
```python
# ============================================================
# 文件说明: xxx_service.py - XXX业务服务层
# ============================================================
# 方法列表:
# 1. get_realtime_data()    - 获取实时数据
# 2. get_history_data()     - 获取历史数据
# ============================================================
```

### 方法注释 (必须)
```python
# ------------------------------------------------------------
# 1. get_realtime_data() - 获取实时数据
# ------------------------------------------------------------
def get_realtime_data(self, device_id: int) -> Dict[str, Any]:
    """获取指定设备的实时数据"""
    pass
```

### 精简原则
- **不要**: 未使用的代码、过度封装、提前优化
- **要做**: 直接实现业务、代码自文档化、必要时才抽象
- **函数**: 单一职责，≤50行
- **类**: 仅在需要状态管理时使用

---

## 5. API 设计规范

### 批量接口 (大屏实时监控)
```http
GET /api/{device}/realtime/batch    # 批量实时数据
GET /api/{device}/history           # 历史数据查询
```

### 单设备接口
```http
GET /api/{device}/{id}              # 单设备实时
GET /api/{device}/{id}/history      # 单设备历史
```

### 系统接口
```http
GET  /api/health                    # 健康检查
GET  /api/health/plc                # PLC 连接状态
GET  /api/config/plc                # PLC 配置
PUT  /api/config/plc                # 更新配置
POST /api/config/plc/test           # 测试连接
```

### 响应格式
```python
# 成功
{"success": True, "data": {...}}

# 失败
{"success": False, "error": "message"}

# 分页
{"success": True, "data": [...], "pagination": {"page": 1, "total": 100}}
```

---

## 6. PLC 通信规范

### S7 配置
```yaml
IP: [192.168.50.223]
Rack: 0  # S7-1200 固定
Slot: 1  # S7-1200 固定
Timeout: 5000ms
Poll_Interval: 6s
```

### 数据类型 (Big Endian)
```python
import snap7.util as s7util

# REAL (32-bit float)
s7util.get_real(data, offset)

# INT (16-bit signed)
s7util.get_int(data, offset)

# DINT (32-bit signed)
s7util.get_dint(data, offset)

# BOOL
s7util.get_bool(data, byte_offset, bit_offset)
```

### 批量读取 (推荐)
```python
# 一次读取整个 DB 块，减少通信开销
data = client.db_read(db_number, start=0, size=100)
```

---

## 7. InfluxDB 规范

### Measurement 设计
```
measurement: {device_type}_{data_type}
tags: device_id, zone_id, sensor_type
fields: temperature, voltage, current, power, flow_rate, weight
```

### 数据保留
```
realtime: 7天 (原始数据)
hourly: 90天 (聚合)
daily: 2年 (聚合)
```

### 批量写入
```python
batch_write_size: 30  # 多少次轮询后批量写入
```

---

## 8. 开发命令

```bash
# 启动
docker-compose up -d              # InfluxDB
uvicorn main:app --reload --port 8080

# 测试
pytest tests/ -v

# 代码检查
ruff check . && ruff format .
```

---

## 9. 环境变量

```bash
# 服务器
SERVER_PORT=8080
DEBUG=true
ENABLE_POLLING=true
MOCK_MODE=false

# PLC
PLC_IP=192.168.50.223
PLC_RACK=0
PLC_SLOT=1

# InfluxDB
INFLUX_URL=http://localhost:8086
INFLUX_TOKEN=ceramic-workshop-token
INFLUX_ORG=ceramic-workshop
INFLUX_BUCKET=sensor_data
```

---

## 10. 常见问题

| 问题 | 解决方案 |
|-----|---------|
| PLC 连接失败 | 检查 IP, Rack=0, Slot=1 |
| 数据解析错误 | 确保 Big Endian 字节序 |
| InfluxDB 写入慢 | 启用批量写入 |
| Address out of range | DB块不存在或大小不足 |

---

## 快速开始新项目

1. **复制此模板**到新项目 `.cursor/rules/my.mdc`
2. **修改第1节**: 项目名称、技术栈
3. **修改第2节**: 设备清单、DB块映射
4. **保留第3-10节**: 通用架构和规范
5. **开始开发**: AI 将按此规范生成代码

---

## 附录: 电流变比说明

| 设备类型 | 变比 | 计算公式 |
|---------|------|---------|
| 辊道窑 | 60 | PLC值 × 0.1 × 60 |
| 其他设备 | 20 | PLC值 × 0.1 × 20 |
