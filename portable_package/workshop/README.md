# 磨料车间 PLC 数据块解析工具

## 目录结构

```
workshop/
├── parse_db8_hoppers.py          # DB8 - 9个料仓数据解析
├── parse_db9_roller_kiln.py      # DB9 - 辊道窑6温区数据解析
├── parse_db10_scr_fans.py        # DB10 - SCR设备+风机数据解析
├── parse_db3_hopper_status.py    # DB3 - 料仓设备状态位解析
├── parse_db7_roller_status.py    # DB7 - 辊道窑设备状态位解析
├── parse_db11_scr_fan_status.py  # DB11 - SCR/风机设备状态位解析
├── run_db8.bat                   # 启动 DB8 解析
├── run_db9.bat                   # 启动 DB9 解析
├── run_db10.bat                  # 启动 DB10 解析
├── run_db3.bat                   # 启动 DB3 解析
├── run_db7.bat                   # 启动 DB7 解析
└── run_db11.bat                  # 启动 DB11 解析
```

## 使用方法

### 方法 1: 双击 bat 文件运行

直接双击对应的 `.bat` 文件即可运行，例如：
- `run_db8.bat` - 查看料仓数据
- `run_db9.bat` - 查看辊道窑数据
- `run_db10.bat` - 查看SCR和风机数据

### 方法 2: 命令行运行

```bash
cd workshop
..\python\python.exe parse_db8_hoppers.py
```

## PLC 连接配置

所有脚本默认连接配置：
```python
PLC_IP = "192.168.50.223"
PLC_RACK = 0
PLC_SLOT = 1
```

如需修改，请编辑对应的 `.py` 文件。

## 数据块说明

### 数据块 (DB8/9/10)

| DB块 | 大小 | 设备 | 数据转换 |
|-----|------|------|---------|
| DB8 | 626字节 | 9个料仓 | 称重×0.1, 温度×0.1, 电流×0.001×20, 功率×0.0001×20, 能耗×2 |
| DB9 | 348字节 | 辊道窑6温区 | 温度×0.1, 电流×0.001×60, 功率×0.0001×60, 能耗×2 |
| DB10 | 244字节 | 2SCR+2风机 | 流量×0.1, 电流×0.001×20, 功率×0.0001×20, 能耗×2 |

**注意**: 辊道窑电流变比=60，其他设备=20

### 状态块 (DB3/7/11)

| DB块 | 大小 | 设备 | 状态结构 |
|-----|------|------|---------|
| DB3 | 148字节 | 9个料仓状态 | Error(Bool) + Status(Word) = 4字节/模块 |
| DB7 | 72字节 | 辊道窑状态 | Error(Bool) + Status(Word) = 4字节/模块 |
| DB11 | 40字节 | SCR/风机状态 | Error(Bool) + Status(Word) = 4字节/模块 |

## 数据转换公式

### 电表数据转换

```python
# 电压 (V)
voltage = raw_value × 0.1

# 电流 (A) - 根据设备类型应用变比
current = raw_value × 0.001 × ratio
  - 辊道窑: ratio = 60
  - 料仓/风机/SCR: ratio = 20

# 功率 (kW)
power = raw_value × 0.0001 × ratio

# 能耗 (kWh)
energy = raw_value × 2
```

### 其他传感器转换

```python
# 称重 (kg)
weight = raw_value × 0.1

# 温度 (°C)
temperature = raw_value × 0.1

# 流量 (m³/h)
flow_rate = raw_value × 0.1

# 累计流量 (m³)
total_flow = raw_value × 1.0
```

## 设备映射

### DB8 料仓映射

| 设备ID | UI显示 | 类型 | 偏移量 | 大小 |
|-------|--------|------|--------|------|
| short_hopper_1 | 7号窑 | 短料仓(有称重) | 0 | 72字节 |
| short_hopper_3 | 5号窑 | 短料仓(有称重) | 72 | 72字节 |
| short_hopper_2 | 6号窑 | 短料仓(有称重) | 144 | 72字节 |
| short_hopper_4 | 4号窑 | 短料仓(有称重) | 216 | 72字节 |
| no_hopper_1 | 2号窑 | 无料仓(无称重) | 288 | 58字节 |
| no_hopper_2 | 1号窑 | 无料仓(无称重) | 346 | 58字节 |
| long_hopper_1 | 8号窑 | 长料仓(双温度) | 404 | 74字节 |
| long_hopper_2 | 3号窑 | 长料仓(双温度) | 478 | 74字节 |
| long_hopper_3 | 9号窑 | 长料仓(双温度) | 552 | 74字节 |

### DB9 辊道窑映射

| 温区 | 温度偏移 | 电表偏移 |
|-----|---------|---------|
| 1号温区 | 0 | 12 |
| 2号温区 | 2 | 68 |
| 3号温区 | 4 | 124 |
| 4号温区 | 6 | 180 |
| 5号温区 | 8 | 236 |
| 6号温区 | 10 | 292 |

### DB10 SCR/风机映射

| 设备 | 类型 | 燃气表偏移 | 电表偏移 | 电表名称 |
|-----|------|-----------|---------|---------|
| scr_1 | SCR | 0 | 10 | 氨泵1电表(表63) |
| scr_2 | SCR | 66 | 188 | 氨泵2电表(表66) |
| fan_1 | 风机 | - | 76 | 风机1电表(表64) |
| fan_2 | 风机 | - | 132 | 风机2电表(表65) |

## 特点

1. **完全独立**: 每个脚本无外部依赖（除 snap7）
2. **硬编码偏移**: 所有偏移量直接写在代码中，无需配置文件
3. **数据转换**: 应用正确的电流变比和单位转换
4. **格式化输出**: 清晰的数据展示，易于阅读
5. **原始数据**: 显示原始字节数据，便于调试

## 依赖

- Python 3.x
- python-snap7

## 注意事项

1. 确保 PLC 网络连接正常
2. 确认 PLC IP 地址正确 (默认 192.168.50.223)
3. 辊道窑电流变比为 60，其他设备为 20
4. 所有脚本使用 Big Endian 字节序解析数据

## 版本

- 创建日期: 2026-02-25
- 基于: ceramic-workshop-backend 配置文件
- 遵循: 奥卡姆剃刀原则 (简单、直接、够用即可)

